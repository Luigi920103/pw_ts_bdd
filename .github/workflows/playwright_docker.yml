name: Playwright BDD Docker Execution
on:
  repository_dispatch:
    types: [run-playwright-docker]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Run Automation Suite
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Java es necesario para que 'allure generate' funcione
      - name: Install Java
        run: |
          apt-get update
          apt-get install -y default-jdk

      - name: Install dependencies
        run: npm ci

      - name: Execute Playwright BDD Tests
        continue-on-error: true # Vital para llegar al paso de los reportes
        run: npm run test-all
        env:
          TEST_ENVIRONMENT: ${{ secrets.TEST_ENVIRONMENT || 'dev' }}
          MONGODB_CONNECTION: ${{ secrets.MONGODB_CONNECTION }}
          MONGODB_DB: ${{ secrets.MONGODB_DB }}
          POSTGRESSQL_HOST: ${{ secrets.POSTGRESSQL_HOST }}
          POSTGRESSQL_PORT: ${{ secrets.POSTGRESSQL_PORT }}
          POSTGRESSQL_DB: ${{ secrets.POSTGRESSQL_DB }}
          POSTGRESSQL_USER: ${{ secrets.POSTGRESSQL_USER }}
          POSTGRESSQL_PASSWORD: ${{ secrets.POSTGRESSQL_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          REGULAR_USER_EMAIL: ${{ secrets.REGULAR_USER_EMAIL }}
          REGULAR_USER_PASSWORD: ${{ secrets.REGULAR_USER_PASSWORD }}

      # 2. Generamos el reporte Allure (para que estÃ© en la carpeta allure-report)
      - name: Generate Allure Report
        if: always()
        run: |
          # Nos aseguramos de que existan los resultados antes de generar
          mkdir -p allure-results
          npm run allure:generate || npx allure generate allure-results --clean -o allure-report

      # 3. Guardamos las 4 carpetas solicitadas en el ZIP de artefactos
      - name: ðŸ“¦ Archive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-execution-results
          path: |
            test-results/
            allure-results/
            allure-report/
            playwright-report/
          retention-days: 5
