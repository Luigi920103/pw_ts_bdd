name: Playwright BDD Docker Execution
on:
  repository_dispatch:
    types: [run-playwright-docker]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write # Crucial para publicar en gh-pages

jobs:
  test:
    name: Run Automation Suite
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy # Versi贸n actualizada

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Java for Allure
        run: |
          apt-get update
          apt-get install -y default-jdk

      - name: Install dependencies
        run: npm ci

      # 1. Recuperar historial de la rama gh-pages
      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages-repo

      - name: Execute Playwright BDD Tests
        continue-on-error: true
        run: npm run test-all
        env:
          TEST_ENVIRONMENT: ${{ vars.TEST_ENVIRONMENT || 'dev' }}
          PAUSE_APP_ON_DEBUG: ${{ vars.PAUSE_APP_ON_DEBUG || 'false' }}
          AUTOMATION_UI_WIDTH: ${{ vars.AUTOMATION_UI_WIDTH || '1366' }}
          AUTOMATION_UI_HEIGHT: ${{ vars.AUTOMATION_UI_HEIGHT || '768' }}
          API_DEBUG: ${{ vars.API_DEBUG || 'true' }}
          
          MONGODB_CONNECTION: ${{ secrets.MONGODB_CONNECTION }}
          MONGODB_DB: ${{ secrets.MONGODB_DB }}
          POSTGRESSQL_HOST: ${{ secrets.POSTGRESSQL_HOST }}
          POSTGRESSQL_PORT: ${{ secrets.POSTGRESSQL_PORT }}
          POSTGRESSQL_DB: ${{ secrets.POSTGRESSQL_DB }}
          POSTGRESSQL_USER: ${{ secrets.POSTGRESSQL_USER }}
          POSTGRESSQL_PASSWORD: ${{ secrets.POSTGRESSQL_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          REGULAR_USER_EMAIL: ${{ secrets.REGULAR_USER_EMAIL }}
          REGULAR_USER_PASSWORD: ${{ secrets.REGULAR_USER_PASSWORD }}

      # 2. Unificar resultados y mezclar con hist贸rico
      - name:  Collect and Generate Allure Report
        if: always()
        run: |
          mkdir -p allure-results
          # Buscamos archivos JSON de resultados por si Playwright los dej贸 en subcarpetas
          find . -name "*-result.json" -exec cp {} allure-results/ \;
          find . -name "*-attachment.*" -exec cp {} allure-results/ \;
          
          # Si existe historial previo en gh-pages-repo, lo copiamos a los resultados actuales
          if [ -d "gh-pages-repo/history" ]; then
            cp -r gh-pages-repo/history allure-results/
          fi
          
          # Generamos el reporte final
          npx allure generate allure-results --clean -o allure-report

      # 3. Publicar en GitHub Pages
      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages

      # 4. Guardar carpetas como artefactos para descarga manual
      - name:  Archive Execution Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-execution-bundle
          path: |
            test-results/
            allure-results/
            allure-report/
            playwright-report/
          retention-days: 7

      # 5. Resumen del Job con el link
      - name: Post Report Summary
        if: always()
        run: |
          echo "###  Resultados de la Ejecuci贸n" >> $GITHUB_STEP_SUMMARY
          echo " **URL del Reporte:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
